@page "/"
@page "/dashboard"
@using LAMAFrontend.Models
@using LAMAFrontend.Services
@inject IMiembroService MiembroService
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageTitle>Dashboard - L.A.M.A. Medellín</PageTitle>

<div class="dashboard-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
        <button class="btn btn-primary" @onclick="RefrescarDatos">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Cargando estadísticas...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
        </div>
    }
    else
    {
        <!-- Tarjetas de Estadísticas Principales -->
        <div class="row g-3 mb-4">
            <!-- Total de Miembros -->
            <div class="col-md-3">
                <div class="card stat-card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted mb-2">Total Miembros</h6>
                                <h2 class="mb-0 fw-bold">@totalMiembros</h2>
                            </div>
                            <div class="stat-icon bg-primary">
                                <i class="bi bi-people-fill"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Miembros Activos -->
            <div class="col-md-3">
                <div class="card stat-card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted mb-2">Miembros Activos</h6>
                                <h2 class="mb-0 fw-bold text-success">@miembrosActivos</h2>
                            </div>
                            <div class="stat-icon bg-success">
                                <i class="bi bi-person-check-fill"></i>
                            </div>
                        </div>
                        <small class="text-muted">@porcentajeActivos% del total</small>
                    </div>
                </div>
            </div>

            <!-- FullColor -->
            <div class="col-md-3">
                <div class="card stat-card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted mb-2">FullColor</h6>
                                <h2 class="mb-0 fw-bold text-success">@fullColor</h2>
                            </div>
                            <div class="stat-icon bg-success">
                                <i class="bi bi-palette-fill"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rockets -->
            <div class="col-md-3">
                <div class="card stat-card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted mb-2">Rockets</h6>
                                <h2 class="mb-0 fw-bold text-warning">@rockets</h2>
                            </div>
                            <div class="stat-icon bg-warning">
                                <i class="bi bi-rocket-fill"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prospect -->
            <div class="col-md-3">
                <div class="card stat-card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted mb-2">Prospect</h6>
                                <h2 class="mb-0 fw-bold">@prospect</h2>
                            </div>
                            <div class="stat-icon bg-secondary">
                                <i class="bi bi-person-fill-question"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <!-- Distribución por Rango -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart-fill text-primary"></i> Distribución por Rango
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container mb-3">
                            @foreach (var rango in estadisticasRango)
                            {
                                <div class="progress-item mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="fw-medium">
                                            <span class="badge bg-@GetRangoBadgeColor(rango.Rango)">@rango.Rango</span>
                                        </span>
                                        <span class="text-muted">@rango.Cantidad (@rango.Porcentaje%)</span>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-@GetRangoBadgeColor(rango.Rango)" 
                                             role="progressbar" 
                                             style="width: @rango.Porcentaje%"
                                             aria-valuenow="@rango.Porcentaje" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distribución por Estatus -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart-fill text-success"></i> Distribución por Estatus
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container mb-3">
                            @foreach (var estatus in estadisticasEstatus)
                            {
                                <div class="progress-item mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="fw-medium">
                                            <span class="badge bg-@GetEstatusBadgeColor(estatus.Estatus)">@estatus.Estatus</span>
                                        </span>
                                        <span class="text-muted">@estatus.Cantidad (@estatus.Porcentaje%)</span>
                                    </div>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-@GetEstatusBadgeColor(estatus.Estatus)" 
                                             role="progressbar" 
                                             style="width: @estatus.Porcentaje%"
                                             aria-valuenow="@estatus.Porcentaje" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <!-- Ciudades con más miembros -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0">
                            <i class="bi bi-geo-alt-fill text-info"></i> Top 5 Ciudades
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            @foreach (var ciudad in topCiudades)
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span><i class="bi bi-pin-map-fill text-info"></i> @ciudad.Ciudad</span>
                                    <span class="badge bg-primary rounded-pill">@ciudad.Cantidad</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ingresos Recientes -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-check-fill text-warning"></i> Ingresos Recientes
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" @onclick="VerTodosMiembros">
                            Ver todos
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Miembro</th>
                                        <th>Fecha Ingreso</th>
                                        <th>Rango</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var miembro in miembrosRecientes)
                                    {
                                        <tr class="cursor-pointer" @onclick="() => VerDetalle(miembro.Id)">
                                            <td>
                                                <div>
                                                    <div class="fw-medium">@miembro.Nombre @miembro.Apellido</div>
                                                    <small class="text-muted">Member #@miembro.Member</small>
                                                </div>
                                            </td>
                                            <td>@miembro.FechaIngreso.ToString("dd/MM/yyyy")</td>
                                            <td>
                                                <span class="badge bg-@GetRangoBadgeColor(miembro.Rango)">@miembro.Rango</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .dashboard-container {
        padding: 20px;
    }

    .stat-card {
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
    }

    .chart-container {
        padding: 10px 0;
    }

    .progress-item {
        margin-bottom: 15px;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .cursor-pointer:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
</style>

@code {
    private List<MiembroDto> miembros = new();
    private bool isLoading = true;
    private string? errorMessage;

    // Estadísticas
    private int totalMiembros;
    private int miembrosActivos;
    private int fullColor;
    private int rockets;
    private int prospect;
    private int porcentajeActivos;

    // Datos para gráficos
    private List<EstadisticaRango> estadisticasRango = new();
    private List<EstadisticaEstatus> estadisticasEstatus = new();
    private List<EstadisticaCiudad> topCiudades = new();
    private List<MiembroDto> miembrosRecientes = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            miembros = (await MiembroService.GetAllMiembrosAsync()).ToList();

            CalcularEstadisticas();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar los datos: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CalcularEstadisticas()
    {
        // Estadísticas generales
        totalMiembros = miembros.Count;
        miembrosActivos = miembros.Count(m => m.Estatus == "Activo");
        fullColor = miembros.Count(m => m.Rango == "FullColor" || m.Rango == "Full Color");
        rockets = miembros.Count(m => m.Rango == "Rockets");
        prospect = miembros.Count(m => m.Rango == "Prospect");
        porcentajeActivos = totalMiembros > 0 ? (int)((miembrosActivos / (double)totalMiembros) * 100) : 0;

        // Estadísticas por rango
        estadisticasRango = miembros
            .GroupBy(m => m.Rango)
            .Select(g => new EstadisticaRango
            {
                Rango = g.Key,
                Cantidad = g.Count(),
                Porcentaje = totalMiembros > 0 ? (int)((g.Count() / (double)totalMiembros) * 100) : 0
            })
            .OrderByDescending(e => e.Cantidad)
            .ToList();

        // Estadísticas por estatus
        estadisticasEstatus = miembros
            .GroupBy(m => m.Estatus)
            .Select(g => new EstadisticaEstatus
            {
                Estatus = g.Key,
                Cantidad = g.Count(),
                Porcentaje = totalMiembros > 0 ? (int)((g.Count() / (double)totalMiembros) * 100) : 0
            })
            .OrderByDescending(e => e.Cantidad)
            .ToList();

        // Top 5 ciudades
        topCiudades = miembros
            .GroupBy(m => m.Ciudad)
            .Select(g => new EstadisticaCiudad
            {
                Ciudad = g.Key,
                Cantidad = g.Count()
            })
            .OrderByDescending(c => c.Cantidad)
            .Take(5)
            .ToList();

        // Miembros recientes (últimos 5 ingresos)
        miembrosRecientes = miembros
            .OrderByDescending(m => m.FechaIngreso)
            .Take(5)
            .ToList();
    }

    private async Task RefrescarDatos()
    {
        await CargarDatos();
    }

    private void VerTodosMiembros()
    {
        NavigationManager.NavigateTo("/miembros");
    }

    private void CrearNuevoMiembro()
    {
        NavigationManager.NavigateTo("/miembros/crear");
    }

    private void VerDetalle(int id)
    {
        NavigationManager.NavigateTo($"/miembros/detalle/{id}");
    }

    private void VerMiembrosActivos()
    {
        NavigationManager.NavigateTo("/miembros?estatus=Activo");
    }

    private void VerFullColor()
    {
        NavigationManager.NavigateTo("/miembros?rango=FullColor");
    }

    private string GetRangoBadgeColor(string rango)
    {
        return rango switch
        {
            "FullColor" => "success",
            "Full Color" => "success",
            "Rockets" => "warning",
            "Prospect" => "secondary",
            _ => "secondary"
        };
    }

    private string GetEstatusBadgeColor(string estatus)
    {
        return estatus switch
        {
            "Activo" => "success",
            "Inactivo" => "secondary",
            "Suspendido" => "danger",
            _ => "secondary"
        };
    }

    // Clases auxiliares para estadísticas
    private class EstadisticaRango
    {
        public string Rango { get; set; } = string.Empty;
        public int Cantidad { get; set; }
        public int Porcentaje { get; set; }
    }

    private class EstadisticaEstatus
    {
        public string Estatus { get; set; } = string.Empty;
        public int Cantidad { get; set; }
        public int Porcentaje { get; set; }
    }

    private class EstadisticaCiudad
    {
        public string Ciudad { get; set; } = string.Empty;
        public int Cantidad { get; set; }
    }
}
